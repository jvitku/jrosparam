#!/bin/sh
#
# Launches java implementation of ROS core. This script uses jars generated by the command ./gradlew installApp, 
# but does not use build/install/jroscore/bin/jroscore script.
# 
# Jroscore is now able to handle SIGTERM signal: (CTRL+C) is passed from the command line to ShutDownInterceptor class, 
# so the RosCore has time to free its address and exit clearly.
#
# author Jaroslav Vitku [vitkujar@fel.cvut.cz]

DEFAULTURI="http://localhost:11311/"
BASEDIR=$(dirname $0)
cd $BASEDIR     # go to the home folder of this script


#################################################### Handle the SIGTERM
cleanup(){
    echo " Sending SIGTERM further.."
    kill -s TERM $PID1
}

##################################################### Help
usage()
{
    echo " "
    echo "Script launches the (java implementation of) RosCore with URI specified in the ROS_MASTER_URI variable"
    echo "If not set, the default URI is used: $DEFAULTURI, usage:"
    echo "-h|\?|help    this help"
    echo "-u|uri        specify your custom URI\n"
}

##################################################### Parse command line
URI=0

OPTIND=1        # Reset in case getopts has been used previously in the shell.
while getopts "urih?help:" opt; do
    case "$opt" in
        h|\?|help)
        usage
        exit 0
        ;;
        u|uri)
        URI=1
        ;;
    esac
done

shift $((OPTIND-1))
[ "$1" = "--" ] && shift

#################################################### Check ROS_MASTER_URI
if [ -z "$ROS_MASTER_URI" ]; then
    echo "[Jroscore]: ROS_MASTER_URI not found -> ROS probably not installed. Setting the default URI."
    ROS_MASTER_URI=$DEFAULTURI
fi

#################################################### Launch the Java RosCore
if [ "$URI" != "1" ]; then
    # some argment without -u prefix?
    if [ "$#" -ne "0" ]; then 
        usage
    fi
    # Launch java core, remember its PID and continue this script
    java -cp "build/install/jroscore/lib/*" ctu.nengoros.Jroscore $DEFAULTURI &
    PID1="$!"
    
else
    echo $PWD
    # Launch java core, remember its PID and continue this script
    java -cp "build/install/jroscore/lib/*" ctu.nengoros.Jroscore $1 &
    PID1="$!"
fi


# set the trap for SIGTERM signal (CTRL+C)
trap "cleanup" 15 2 18

# wait for java to finish
wait


